<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulus Pro - Kelompok Satu</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { enableMenu: false }
        };
    </script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/Solve.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/d3@3/d3.min.js"></script>
    <script src="https://unpkg.com/function-plot@1/dist/function-plot.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase V8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --bg-body: #0a0e17; 
            --primary-gradient: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            --primary-glow: rgba(168, 85, 247, 0.5);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --chat-me: #6366f1;
            --chat-other: #1e293b;
            --navbar-bg: rgba(10, 14, 23, 0.95);
            --success-color: #10b981;
        }

        [data-theme="light"] {
            --bg-body: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --input-bg: #ffffff;
            --chat-other: #e2e8f0;
            --navbar-bg: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding-top: 80px; overflow-x: hidden; }

        .navbar { position: fixed; top: 0; width: 100%; background: var(--navbar-bg); backdrop-filter: blur(15px); border-bottom: 1px solid var(--glass-border); z-index: 1000; height: 80px; display: flex; align-items: center; }
        .nav-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: var(--text-main); }
        .logo span { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .desktop-menu { display: flex; gap: 1.2rem; }
        .desktop-link { color: var(--text-muted); text-decoration: none; font-weight: 500; cursor: pointer; position: relative; padding: 5px 0; font-size: 0.9rem; }
        .desktop-link.active { color: #a855f7; font-weight: 700; border-bottom: 2px solid #a855f7; }

        .page-section { display: none; padding: 2rem 1rem; max-width: 1200px; margin: 0 auto; animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .active-page { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 1.8rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        
        .btn-gradient { width: 100%; padding: 14px; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 1rem; }
        .btn-gradient:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--primary-glow); }

        input, select, textarea { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-main); margin-bottom: 10px; font-family: inherit; font-size: 1rem; }

        .visual-box { width: 100%; height: 380px; background: var(--input-bg); border-radius: 15px; border: 1px solid var(--glass-border); overflow: hidden; position: relative; }
        .function-plot path.line { stroke-dasharray: 2500; stroke-dashoffset: 2500; animation: drawLine 2.5s ease-out forwards; }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .chat-messages { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 15px; }
        .message-bubble { max-width: 85%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; }
        .msg-self { align-self: flex-end; background: var(--primary-gradient); color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: var(--chat-other); color: var(--text-main); border-bottom-left-radius: 4px; }

        .team-card { text-align: center; padding: 2rem 1rem; }
        .team-card img { width: 110px; height: 110px; border-radius: 50%; border: 4px solid #a855f7; object-fit: cover; margin-bottom: 15px; }
        .role-badge { background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: inline-block; margin-bottom: 10px; }
        .quote { font-style: italic; font-size: 0.85rem; color: var(--text-muted); margin-top: 10px; line-height: 1.4; }

        .auth-toggle { color: #a855f7; cursor: pointer; font-weight: 700; text-decoration: underline; margin-top: 10px; display: inline-block; }
        .forgot-pass { font-size: 0.85rem; color: var(--text-muted); cursor: pointer; display: block; margin-top: 10px; }
    </style>
</head>
<body data-theme="dark">

    <nav class="navbar">
        <div class="nav-container">
            <a href="#" onclick="switchPage('home')" class="logo">Kalkulus<span>Pro</span></a>
            <div class="desktop-menu">
                <a class="desktop-link active" onclick="switchPage('home')" id="nav-home">Materi</a>
                <a class="desktop-link" onclick="switchPage('calculator')" id="nav-calculator">Kalkulator</a>
                <a class="desktop-link" onclick="switchPage('chat')" id="nav-chat">Diskusi</a>
                <a class="desktop-link" onclick="switchPage('feedback')" id="nav-feedback">Feedback</a>
                <a class="desktop-link" onclick="switchPage('about')" id="nav-about">Tim</a>
            </div>
            <button id="theme-toggle" onclick="toggleTheme()" style="background:none; border:none; color:var(--text-main); cursor:pointer;"><i class="fa-solid fa-circle-half-stroke"></i></button>
        </div>
    </nav>

    <!-- DASHBOARD MATERI -->
    <section id="home" class="page-section active-page">
        <div style="text-align:center; margin-bottom:3rem;">
            <h1 style="font-size: 2.8rem;" class="logo"><span>Eksplorasi</span> Kalkulus</h1>
            <p style="color:var(--text-muted);">Program ini dibuat sebagai bagian dari rangkaian tugas besar mata kuliah Kalkulus, Program Studi Pendidikan Ilmu Komputer, Fakultas Pendidikan Matematika dan Pengetahuan Alam, Universitas Pendidikan Indonesia.</p>
        </div>
        <div class="grid-container">
            <div class="glass-card"><h3>Sistem Bilangan Real</h3><p>Fondasi utama kalkulus mengenai himpunan $\mathbb{R}$, interval, dan nilai mutlak.</p><button class="btn-gradient" onclick="openDetail('bilangan')">Pelajari</button></div>
            <div class="glass-card"><h3>Fungsi & Grafik</h3><p>Aturan pemetaan, domain, range, serta transformasi fungsi visual.</p><button class="btn-gradient" onclick="openDetail('fungsi')">Pelajari</button></div>
            <div class="glass-card"><h3>Limit & Kekontinuan</h3><p>Perilaku fungsi saat mendekati titik tertentu dan konsep grafik tanpa putus.</p><button class="btn-gradient" onclick="openDetail('limit')">Pelajari</button></div>
            <div class="glass-card"><h3>Turunan (Diferensial)</h3><p>Konsep laju perubahan sesaat, kemiringan garis singgung, dan aturan rantai.</p><button class="btn-gradient" onclick="openDetail('turunan')">Pelajari</button></div>
            <div class="glass-card"><h3>Integral Tentu</h3><p>Perhitungan akumulasi luas daerah di bawah kurva fungsi $f(x)$.</p><button class="btn-gradient" onclick="openDetail('integral')">Pelajari</button></div>
            <div class="glass-card"><h3>Volume Benda Putar</h3><p>Pemanfaatan integral untuk menghitung volume objek 3D hasil rotasi.</p><button class="btn-gradient" onclick="openDetail('volume')">Pelajari</button></div>
        </div>
    </section>

    <!-- DETAIL MATERI -->
    <section id="detail-materi" class="page-section">
        <button onclick="switchPage('home')" style="background:none; border:none; color:#a855f7; cursor:pointer; font-weight:700; margin-bottom:1.5rem;"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
        <div style="display: grid; grid-template-columns: 1.4fr 1fr; gap: 2rem;">
            <div class="glass-card">
                <h2 id="detail-title" class="logo"><span>Judul</span></h2>
                <div id="detail-desc" style="line-height:1.8; text-align: justify; font-size: 0.95rem;"></div>
                <h4 style="color:#a855f7; margin-top:20px;">Konsep Fundamental:</h4>
                <ul id="detail-points" style="line-height:2.2; font-size: 0.95rem;"></ul>
            </div>
            <div class="glass-card">
                <h4>Visualisasi Interaktif</h4>
                <div id="detail-graph" class="visual-box"></div>
                <h4 style="color:#a855f7; margin-top:20px;">Persamaan Penting:</h4>
                <div id="detail-formula" style="text-align:center; padding:15px; background:var(--input-bg); border-radius:12px;"></div>
            </div>
        </div>
    </section>

    <!-- KALKULATOR -->
    <section id="calculator" class="page-section">
        <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
            <h2 class="logo"><span>Studio</span> Kalkulasi</h2>
            <div style="border: 2px dashed var(--glass-border); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
                <input type="file" id="scan-file" accept="image/*" style="display:none;" onchange="processOCR(event)">
                <label for="scan-file" style="cursor:pointer; color:#a855f7;"><i class="fa-solid fa-camera" style="font-size:2rem;"></i><br>Scan Soal (OCR Mode)</label>
            </div>
            
            <select id="op-select" onchange="toggleInputs()">
                <option value="simplify">Sederhanakan Aljabar</option>
                <option value="diff">Turunan Pertama $f'(x)$</option>
                <option value="limit">Limit Fungsi $x \to c$</option>
                <option value="defint">Integral Tentu (Luas)</option>
                <option value="volume">Volume Benda Putar (Sumbu X)</option>
            </select>
            <input type="text" id="expr-input" placeholder="Masukkan fungsi, misal: x^2 + 2x">
            <div id="extra-inputs" style="display:none; gap:10px;">
                <input type="text" id="lim-a" placeholder="Bawah / c">
                <input type="text" id="lim-b" placeholder="Atas">
            </div>
            <button class="btn-gradient" onclick="runCalculation()">Proses Hitung</button>
            
            <div id="calc-result" class="glass-card" style="margin-top: 2rem; display:none;">
                <h4>Hasil:</h4>
                <div id="res-math" style="font-size: 1.6rem; text-align: center; margin-bottom: 1.5rem; color:#a855f7;"></div>
                <div id="res-graph" class="visual-box"></div>
            </div>
        </div>
    </section>

    <!-- DISKUSI -->
    <section id="chat" class="page-section">
        <div class="glass-card" style="max-width: 500px; margin: 0 auto;">
            <!-- LOGIN/REGISTER AREA -->
            <div id="auth-area">
                <h2 id="auth-title" style="text-align:center;">Masuk Akun</h2>
                <div id="reg-fields" style="display:none;">
                    <input type="text" id="auth-name" placeholder="Nama Lengkap">
                </div>
                <input type="email" id="auth-email" placeholder="Email">
                <input type="password" id="auth-password" placeholder="Password">
                <button class="btn-gradient" id="btn-auth-action" onclick="handleAuth()">Masuk</button>
                <div style="text-align: center;">
                    <span class="forgot-pass" onclick="resetPassword()">Lupa Password?</span>
                    <span id="auth-switch-text" style="font-size: 0.9rem;">Belum punya akun?</span> 
                    <span class="auth-toggle" onclick="toggleAuthMode()">Daftar di sini</span>
                </div>
            </div>

            <!-- VERIFICATION AREA -->
            <div id="verify-area" style="display: none; text-align: center;">
                <i class="fa-solid fa-envelope-circle-check" style="font-size: 4rem; color: #a855f7; margin-bottom: 1rem;"></i>
                <h3>Verifikasi Email Anda</h3>
                <p style="font-size: 0.9rem; color: var(--text-muted);">Link verifikasi telah dikirim. Silakan klik link di email Anda lalu klik tombol di bawah.</p>
                <button class="btn-gradient" onclick="checkVerification()">Saya Sudah Verifikasi</button>
                <button class="btn-gradient" style="background: transparent; border: 1px solid #a855f7; color: #a855f7;" onclick="logout()">Ganti Akun</button>
            </div>

            <!-- CHAT INTERFACE -->
            <div id="chat-area" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span id="user-name-tag" style="font-weight:700; color:#a855f7;"></span>
                    <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-weight: 700;">Keluar</button>
                </div>
                <div class="chat-messages" id="chat-msgs"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="msg-input" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="btn-gradient" style="margin:0; width:55px;"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </section>

    <!-- FEEDBACK -->
    <section id="feedback" class="page-section">
        <div class="glass-card" style="max-width: 600px; margin: 0 auto; text-align:center;">
            <div id="fb-form">
                <h2>Feedback</h2>
                <input type="text" id="fb-name" placeholder="Nama">
                <textarea id="fb-msg" rows="4" placeholder="Saran Anda"></textarea>
                <button class="btn-gradient" onclick="submitFeedback()">Kirim</button>
            </div>
            <div id="fb-thanks" style="display:none;">
                <h3>Terima Kasih atas Feedbacknya!</h3>
            </div>
        </div>
    </section>

    <!-- TIM -->
    <section id="about" class="page-section">
        <div class="grid-container">
            <div class="glass-card team-card">
                <img src="raya.jpg"><h3>Aditya Raya</h3><span class="role-badge">Project Manager</span><p>NIM: 2507320</p>
                <p class="quote">"Matematika adalah bahasa alam semesta yang paling murni."</p>
            </div>
            <div class="glass-card team-card">
                <img src="azka.jpg"><h3>Azka Ramadhan</h3><span class="role-badge">Lead Programmer</span><p>NIM: 12334</p>
                <p class="quote">"Logika membawa Anda dari A ke B, imajinasi membawa Anda ke mana saja."</p>
            </div>
            <div class="glass-card team-card">
                <img src="salsa.jpg"><h3>Salsa Nur</h3><span class="role-badge">UI Designer</span><p>NIM: 2501960</p>
                <p class="quote">"Desain bukan hanya apa yang terlihat, tapi bagaimana cara kerjanya."</p>
            </div>
            <div class="glass-card team-card">
                <img src="novi.jpg"><h3>Novi Nur</h3><span class="role-badge">Content Analyst</span><p>NIM: 2507647</p>
                <p class="quote">"Materi yang baik adalah kunci dari pemahaman yang mendalam."</p>
            </div>
        </div>
    </section>

    <script>
        // --- DATA MATERI TERLENGKAP ---
        const materialData = {
            'bilangan': {
                title: 'Sistem Bilangan Real',
                desc: 'Sistem bilangan real $\\mathbb{R}$ adalah dasar utama kalkulus. Ia mencakup bilangan rasional (dapat dinyatakan sebagai $\\frac{a}{b}$) dan bilangan irasional (seperti $\\pi$ atau $\\sqrt{2}$). Sifat kelengkapan bilangan real menjamin bahwa setiap himpunan yang memiliki batas atas pasti memiliki supremum.',
                points: ['Himpunan Bilangan Bulat, Rasional, dan Irasional', 'Sifat Urutan: Trikotomi, Transitif, Penjumlahan, dan Perkalian', 'Interval Selang: Terbuka $(a,b)$, Tertutup $[a,b]$, dan Setengah Terbuka', 'Ketidaksamaan Nilai Mutlak: $|x| < a \\iff -a < x < a$', 'Pertidaksamaan Kuadrat dan Teknik Uji Titik'],
                formula: '$$|x-a| < \\delta \\iff a-\\delta < x < a+\\delta$$',
                graphFn: 'abs(x)'
            },
            'fungsi': {
                title: 'Fungsi & Grafik',
                desc: 'Fungsi adalah aturan pemetaan yang menghubungkan setiap elemen dari domain ke tepat satu elemen di range. Dalam kalkulus, kita fokus pada fungsi bernilai real. Transformasi grafik memungkinkan kita menggeser, mencerminkan, atau meregangkan fungsi dasar.',
                points: ['Uji Garis Vertikal untuk Definisi Fungsi', 'Fungsi Genap $f(-x)=f(x)$ & Fungsi Ganjil $f(-x)=-f(x)$', 'Fungsi Komposisi $(f \\circ g)(x)$ dan Domain Terkait', 'Transformasi: Pergeseran Horizontal/Vertikal dan Dilatasi', 'Fungsi Transenden: Trigonometri, Eksponensial, dan Logaritma'],
                formula: '$$y = f(x) \\rightarrow y = a \\cdot f(x-h) + k$$',
                graphFn: 'x^2'
            },
            'limit': {
                title: 'Limit & Kekontinuan',
                desc: 'Limit menjelaskan perilaku fungsi saat variabel independen mendekati nilai tertentu. Konsep limit adalah pintu masuk menuju turunan. Fungsi dikatakan kontinu jika nilai limit di suatu titik sama dengan nilai fungsi di titik tersebut.',
                points: ['Limit Sisi Kiri $\\lim_{x \\to c^-}$ dan Sisi Kanan $\\lim_{x \\to c^+}$', 'Teorema Limit Utama (Penjumlahan, Perkalian, Pembagian)', 'Bentuk Tak Tentu: $0/0$, $\\infty/\\infty$, dan Aturan L\'Hopital', 'Teorema Apit (Squeeze Theorem) untuk Limit Trigonometri', 'Limit di Tak Hingga dan Asimtot Horizontal'],
                formula: '$$\\lim_{x \\to c} f(x) = f(c) \\implies \\text{Kontinu}$$',
                graphFn: 'sin(x)/x'
            },
            'turunan': {
                title: 'Turunan (Diferensial)',
                desc: 'Turunan mengukur laju perubahan sesaat suatu fungsi. Secara geometri, ini adalah gradien garis singgung kurva. Turunan diaplikasikan luas dalam fisika (kecepatan sesaat) dan optimasi ekonomi.',
                points: ['Definisi Limit Turunan (Diferensial)', 'Aturan Rantai (Chain Rule) untuk Fungsi Komposisi', 'Turunan Fungsi Trigonometri dan Inversnya', 'Aplikasi: Titik Stasioner, Nilai Maksimum/Minimum Lokal', 'Uji Turunan Kedua untuk Penentuan Kecekungan Kurva'],
                formula: '$$f\'(x) = \\lim_{h \\to 0} \\frac{f(x+h)-f(x)}{h}$$',
                graphFn: '3*x^2'
            },
            'integral': {
                title: 'Integral Tentu',
                desc: 'Integral adalah kebalikan dari proses turunan (Anti-turunan). Integral tentu secara visual mewakili luas daerah yang dibatasi oleh kurva $f(x)$ dan sumbu $x$ pada interval $[a,b]$.',
                points: ['Teorema Dasar Kalkulus I & II', 'Teknik Integrasi: Substitusi $u$ dan Integral Parsial', 'Luas Daerah di Antara Dua Kurva', 'Integral Fungsi Trigonometri Kuadrat', 'Sifat Linearitas dan Additivitas Integral'],
                formula: '$$\\int_{a}^{b} f(x) dx = F(b) - F(a)$$',
                graphFn: 'x^2 + 1'
            },
            'volume': {
                title: 'Volume Benda Putar',
                desc: 'Volume benda putar diperoleh dari pemutaran suatu luasan daerah terhadap sumbu koordinat tertentu. Teknik ini mengubah masalah 2D menjadi 3D menggunakan prinsip integrasi.',
                points: ['Metode Cakram (Disk Method) untuk Daerah Tanpa Lubang', 'Metode Cincin (Washer Method) untuk Daerah Berlubang', 'Metode Kulit Tabung (Shell Method) sebagai Alternatif', 'Perputaran terhadap Sumbu $X$ vs Sumbu $Y$', 'Volume Irisan Sejajar dan Penampang Melintang'],
                formula: '$$V = \\pi \\int_{a}^{b} [f(x)]^2 dx$$',
                graphFn: 'sqrt(x)'
            }
        };

        // --- FIREBASE LOGIC ---
        const firebaseConfig = {
            apiKey: "AIzaSyAaJ8idRMCpd0DCqWM-uWTsRqHKy90moh0",
            authDomain: "program-kalkulus.firebaseapp.com",
            databaseURL: "https://program-kalkulus-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "program-kalkulus",
            storageBucket: "program-kalkulus.firebasestorage.app",
            messagingSenderId: "259125021336",
            appId: "1:259125021336:web:58b3601c91bed862a79eed"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let isLoginMode = true;

        auth.onAuthStateChanged(user => {
            const authArea = document.getElementById('auth-area');
            const verifyArea = document.getElementById('verify-area');
            const chatArea = document.getElementById('chat-area');
            
            if (user) {
                authArea.style.display = 'none';
                if (user.emailVerified) {
                    verifyArea.style.display = 'none';
                    chatArea.style.display = 'block';
                    document.getElementById('user-name-tag').innerText = user.displayName || user.email;
                    loadMsgs();
                } else {
                    verifyArea.style.display = 'block';
                    chatArea.style.display = 'none';
                }
            } else {
                authArea.style.display = 'block';
                verifyArea.style.display = 'none';
                chatArea.style.display = 'none';
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Masuk Akun" : "Daftar Akun";
            document.getElementById('reg-fields').style.display = isLoginMode ? "none" : "block";
            document.getElementById('btn-auth-action').innerText = isLoginMode ? "Masuk" : "Daftar";
            document.getElementById('auth-switch-text').innerText = isLoginMode ? "Belum punya akun?" : "Sudah punya akun?";
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            try {
                if(isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    if(!name) return alert("Nama wajib diisi!");
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await res.user.updateProfile({ displayName: name });
                    await res.user.sendEmailVerification();
                    alert("Akun berhasil didaftar! Silakan cek email Anda untuk verifikasi.");
                }
            } catch(e) { alert(e.message); }
        }

        function checkVerification() {
            auth.currentUser.reload().then(() => {
                if(auth.currentUser.emailVerified) location.reload();
                else alert("Email belum diverifikasi. Cek folder Inbox/Spam email Anda.");
            });
        }

        function resetPassword() {
            const email = document.getElementById('auth-email').value;
            if(!email) return alert("Masukkan email Anda di kolom email.");
            auth.sendPasswordResetEmail(email).then(() => alert("Link reset password telah dikirim ke email Anda."));
        }

        function logout() { auth.signOut(); }

        // --- CORE UI ---
        function switchPage(id) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            document.querySelectorAll('.desktop-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function openDetail(key) {
            const data = materialData[key];
            document.getElementById('detail-title').innerHTML = `<span>${data.title}</span>`;
            document.getElementById('detail-desc').innerHTML = data.desc;
            const list = document.getElementById('detail-points');
            list.innerHTML = '';
            data.points.forEach(p => list.innerHTML += `<li>${p}</li>`);
            document.getElementById('detail-formula').innerHTML = data.formula;
            renderSmoothGraph('#detail-graph', data.graphFn);
            MathJax.typesetPromise();
            switchPage('detail-materi');
        }

        function renderSmoothGraph(target, fn) {
            const container = document.querySelector(target);
            container.innerHTML = '';
            try {
                functionPlot({
                    target: target,
                    width: container.clientWidth,
                    height: 380,
                    grid: true,
                    data: [{ fn: fn, color: '#a855f7' }]
                });
                const path = d3.select(target).select('path.line');
                const len = path.node().getTotalLength();
                path.attr("stroke-dasharray", len + " " + len).attr("stroke-dashoffset", len)
                    .transition().duration(2200).ease("cubic-out").attr("stroke-dashoffset", 0);
            } catch(e) {}
        }

        // --- CALC ---
        function toggleInputs() {
            const op = document.getElementById('op-select').value;
            document.getElementById('extra-inputs').style.display = (op === 'simplify' || op === 'diff') ? 'none' : 'flex';
        }

        function runCalculation() {
            const expr = document.getElementById('expr-input').value;
            const op = document.getElementById('op-select').value;
            const a = document.getElementById('lim-a').value;
            const b = document.getElementById('lim-b').value;
            if(!expr) return alert("Masukkan fungsi!");
            try {
                let res;
                if(op === 'simplify') res = nerdamer.simplify(expr).toTeX();
                else if(op === 'diff') res = nerdamer.diff(expr).toTeX();
                else if(op === 'limit') res = nerdamer(`limit(${expr}, x, ${a})`).toTeX();
                else if(op === 'defint') res = nerdamer(`defint(${expr}, ${a}, ${b})`).toTeX();
                else if(op === 'volume') {
                    const integral = nerdamer(`defint((${expr})^2, ${a}, ${b})`);
                    res = `V = ${(eval(integral.toString()) * Math.PI).toFixed(4)} \\pi`;
                }
                document.getElementById('calc-result').style.display = 'block';
                document.getElementById('res-math').innerHTML = `$$ ${res} $$`;
                renderSmoothGraph('#res-graph', expr);
                MathJax.typesetPromise();
            } catch (e) { alert("Error hitung."); }
        }

        // --- MISC ---
        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            db.ref('messages').push({ user: auth.currentUser.displayName || auth.currentUser.email, text: input.value, uid: auth.currentUser.uid });
            input.value = '';
        }

        function loadMsgs() {
            db.ref('messages').limitToLast(15).on('child_added', snap => {
                const m = snap.val();
                const div = document.createElement('div');
                div.className = `message-bubble ${m.uid === auth.currentUser.uid ? 'msg-self' : 'msg-other'}`;
                div.innerHTML = `<strong>${m.user}</strong><br>${m.text}`;
                document.getElementById('chat-msgs').appendChild(div);
                document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
            });
        }

        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function submitFeedback() { document.getElementById('fb-form').style.display='none'; document.getElementById('fb-thanks').style.display='block'; }
        function processOCR(e) { Tesseract.recognize(e.target.files[0], 'eng').then(({ data: { text } }) => { document.getElementById('expr-input').value = text.toLowerCase().replace(/[^a-z0-9\+\-\*\/\^]/g, ''); }); }
    </script>
</body>
</html>

